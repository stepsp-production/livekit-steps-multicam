<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps Co VIP Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
  <style>
    :root{--btn-bg:#00c19a;--btn-bg-h:#00ad8a;--btn-bg-a:#009e7e;--btn-txt:#fff;--panel-bg:#0b0b0fe6;--panel-bd:#ffffff26;}
    body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #playerContainer{position:relative;width:100vw;height:100vh;overflow:hidden}
    #activeCam,#mainPreview{position:absolute;inset:0}
    #utilityControls,#globalControls{position:absolute;z-index:12;display:flex;gap:8px;transition:opacity .18s}
    #utilityControls{top:10px;right:10px}
    #globalControls{bottom:20px;left:50%;transform:translateX(-50%);background:var(--panel-bg);padding:10px;border-radius:12px;border:1px solid var(--panel-bd)}
    .ui-hidden #utilityControls,.ui-hidden #globalControls,.ui-hidden #lkPanel{opacity:0;pointer-events:none}
    .ui-visible #utilityControls,.ui-visible #globalControls,.ui-visible #lkPanel{opacity:1;pointer-events:auto}
    button{background:var(--btn-bg);color:#fff;border:0;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer}
    #lkPanel{position:absolute;right:14px;bottom:14px;background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:12px;padding:10px}
    #lkGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;max-height:33vh;overflow:auto}
    .tile{position:relative;background:#0b0b0f;border:1px solid #ffffff22;border-radius:10px;min-height:90px;overflow:hidden}
    .badge{position:absolute;left:6px;top:6px;background:#000a;border:1px solid #fff2;border-radius:999px;padding:2px 6px;font-size:10px}
  </style>
</head>
<body>
  <div id="playerContainer" class="ui-visible">
    <div id="activeCam"></div>
    <div id="mainPreview"></div>

    <div id="utilityControls">
      <button id="btnSplit">تقسيم</button>
      <button id="btnFill">ملء</button>
      <button id="btnSound">🔊/🔇</button>
    </div>

    <div id="globalControls" class="hidden">
      <button id="gBack">⏪ 5s</button>
      <button id="gPlay">⏯</button>
      <button id="gFwd">5s ⏩</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>

    <div id="lkPanel">
      <div style="font-weight:800;margin-bottom:6px">الغرفة المباشرة (LiveKit)</div>
      <div>
        <select id="lkRoom">
          <option>studio-1</option><option>studio-2</option><option>studio-3</option><option>studio-4</option><option>studio-5</option>
          <option>studio-6</option><option>studio-7</option><option>studio-8</option><option>studio-9</option><option>studio-10</option>
        </select>
        <input id="lkName" placeholder="اسم العرض (اختياري)" />
        <button id="lkJoin">انضم للغرفة</button>
        <button id="lkLeave" disabled>مغادرة</button>
        <button id="lkToggleCam" disabled>الكاميرا</button>
        <button id="lkToggleMic" disabled>المايك</button>
      </div>
      <div id="lkGrid"></div>
    </div>
  </div>

  <script>
    // ------- Dummy minimal video to keep page consistent (HLS not required for join test) -------
    const root=document.getElementById('playerContainer');
    const mainPreview=document.getElementById('mainPreview');
    const activeCam=document.getElementById('activeCam');
    const globalControls=document.getElementById('globalControls');
    const btnSound=document.getElementById('btnSound');
    let started=false;
    const v1=document.createElement('video'); v1.muted=true; v1.autoplay=true; v1.loop=true; v1.src=''; mainPreview.appendChild(v1);
    const v2=document.createElement('video'); v2.muted=true; v2.autoplay=true; v2.loop=true; v2.src=''; activeCam.appendChild(v2);
    function showUI(){ root.classList.remove('ui-hidden'); root.classList.add('ui-visible'); clearTimeout(window.__uit); window.__uit=setTimeout(()=>{root.classList.add('ui-hidden'); root.classList.remove('ui-visible');},2500);}
    ['mousemove','touchstart','keydown'].forEach(ev=>root.addEventListener(ev,showUI,{passive:true})); showUI();
    document.getElementById('gPlay').addEventListener('click',()=>{ globalControls.classList.remove('hidden'); started=true; });
    btnSound.addEventListener('click',()=>{});
  </script>

  <script>
    // ===== LiveKit join logic =====
    const lkRoomSel   = document.getElementById('lkRoom');
    const lkNameInput = document.getElementById('lkName');
    const lkJoinBtn   = document.getElementById('lkJoin');
    const lkLeaveBtn  = document.getElementById('lkLeave');
    const lkToggleCam = document.getElementById('lkToggleCam');
    const lkToggleMic = document.getElementById('lkToggleMic');
    const lkGrid      = document.getElementById('lkGrid');

    let lkRoom = null;
    let localCamEnabled = true;
    let localMicEnabled = true;

    function addTrackTile(track, label){
      const tile = document.createElement('div');
      tile.className = 'tile';
      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.textContent = label;
      tile.appendChild(badge);
      const mediaEl = track.attach();
      if(mediaEl instanceof HTMLVideoElement){
        mediaEl.playsInline = true;
        mediaEl.muted = (label === 'أنا');
        mediaEl.autoplay = true;
      }
      tile.appendChild(mediaEl);
      lkGrid.appendChild(tile);
      const detach = () => {
        try{ track.detach().forEach(el => el.remove()); }catch(e){}
        try{ tile.remove(); }catch(e){}
      };
      return detach;
    }
    function cleanupGrid(){[...lkGrid.children].forEach(ch => ch.remove());}

    async function fetchLiveKitToken({ room, identity, name }){
      const resp = await fetch('/api/livekit-token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ room, identity, name })
      });
      if(!resp.ok){
        const txt = await resp.text().catch(()=>'');
        throw new Error('Token request failed: ' + resp.status + ' ' + txt);
      }
      return resp.json();
    }

    async function joinLiveKit(){
      if(lkRoom) return;
      try{
        const roomName = lkRoomSel.value;
        const displayName = lkNameInput.value.trim() || undefined;
        const { token, wsUrl } = await fetchLiveKitToken({ room: roomName, name: displayName });

        lkRoom = await LiveKit.connect(wsUrl, token, { autoSubscribe: true, stopLocalTrackOnUnpublish: true });

        const tracks = await LiveKit.createLocalTracks({ audio: true, video: { facingMode: 'user' } });
        for (const t of tracks) await lkRoom.localParticipant.publishTrack(t);

        for (const pub of lkRoom.localParticipant.trackPublications.values()) {
          if (pub.track) addTrackTile(pub.track, 'أنا');
        }

        const unsubscribers = new Map();
        lkRoom
          .on(LiveKit.RoomEvent.TrackSubscribed, (track, publication, participant) => {
            const detach = addTrackTile(track, participant.identity || 'ضيف');
            unsubscribers.set(publication.sid, detach);
          })
          .on(LiveKit.RoomEvent.TrackUnsubscribed, (_track, publication) => {
            const d = unsubscribers.get(publication.sid);
            if (d){ try{ d(); }catch(e){} unsubscribers.delete(publication.sid); }
          })
          .on(LiveKit.RoomEvent.Disconnected, () => cleanupGrid());

        lkJoinBtn.disabled = true;
        lkLeaveBtn.disabled = false;
        lkToggleCam.disabled = false;
        lkToggleMic.disabled = false;
      } catch (e){
        console.error('joinLiveKit error', e);
        alert('تعذّر الانضمام: ' + (e?.message || e));
      }
    }

    async function leaveLiveKit(){
      if(!lkRoom) return;
      try{ await lkRoom.disconnect(); }catch(e){}
      lkRoom = null; cleanupGrid();
      lkJoinBtn.disabled = false; lkLeaveBtn.disabled = true;
      lkToggleCam.disabled = true; lkToggleMic.disabled = true;
      localCamEnabled = true; localMicEnabled = true;
    }

    lkJoinBtn.addEventListener('click', joinLiveKit);
    lkLeaveBtn.addEventListener('click', leaveLiveKit);
    lkToggleCam.addEventListener('click', async ()=>{
      if(!lkRoom) return;
      localCamEnabled = !localCamEnabled;
      try{ await lkRoom.localParticipant.setCameraEnabled(localCamEnabled); }catch(e){}
      lkToggleCam.textContent = localCamEnabled ? 'الكاميرا' : 'تشغيل الكاميرا';
    });
    lkToggleMic.addEventListener('click', async ()=>{
      if(!lkRoom) return;
      localMicEnabled = !localMicEnabled;
      try{ await lkRoom.localParticipant.setMicrophoneEnabled(localMicEnabled); }catch(e){}
      lkToggleMic.textContent = localMicEnabled ? 'المايك' : 'تشغيل المايك';
    });
  </script>
</body>
</html>
